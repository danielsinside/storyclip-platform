<!DOCTYPE html>
<html>
<head>
    <title>Test Headers - Upload Direct</title>
</head>
<body>
    <h1>Test Headers Upload Direct</h1>
    <input type="file" id="fileInput" accept="video/*">
    <button onclick="testUpload()">Test Upload</button>
    <div id="result"></div>

    <script>
        async function sha256ArrayBuffer(buf) {
            const hash = await crypto.subtle.digest('SHA-256', buf);
            return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function buildIdempotencyKey(file, options) {
            const fileBuffer = await file.arrayBuffer();
            const fileHash = await sha256ArrayBuffer(fileBuffer);
            
            const optionsStr = JSON.stringify(options, Object.keys(options).sort());
            const optionsBuffer = new TextEncoder().encode(optionsStr);
            const optionsHash = await sha256ArrayBuffer(optionsBuffer.buffer);
            
            return `${fileHash}:${optionsHash}`;
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const result = document.getElementById('result');
            
            if (!fileInput.files[0]) {
                result.innerHTML = '<p style="color: red;">Selecciona un archivo primero</p>';
                return;
            }

            const file = fileInput.files[0];
            const options = {
                slicing: {
                    mode: 'manual_exact',
                    clips_total: 3,
                    clip_duration_seconds: 1.5
                }
            };

            try {
                const flowId = crypto.randomUUID();
                const idem = await buildIdempotencyKey(file, options);
                
                console.log('Headers que se enviar√°n:');
                console.log('Idempotency-Key:', idem);
                console.log('X-Flow-Id:', flowId);

                const fd = new FormData();
                fd.append('file', file);
                fd.append('options', JSON.stringify(options));

                const headers = new Headers();
                headers.set('Idempotency-Key', idem);
                headers.set('X-Flow-Id', flowId);

                result.innerHTML = '<p>Enviando request...</p>';

                const res = await fetch('https://storyclip.creatorsflow.app/api/videos/upload-direct', {
                    method: 'POST',
                    body: fd,
                    headers,
                    credentials: 'include',
                    referrerPolicy: 'strict-origin-when-cross-origin'
                });

                const data = await res.json();
                
                result.innerHTML = `
                    <h3>Resultado:</h3>
                    <p><strong>Status:</strong> ${res.status}</p>
                    <p><strong>Job ID:</strong> ${data.job_id || 'No job_id'}</p>
                    <p><strong>Status:</strong> ${data.status || 'No status'}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                result.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
